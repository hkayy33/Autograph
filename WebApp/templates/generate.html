{% extends "base.html" %}

{% block title %}Generate Autograph{% endblock %}

{% block content %}
<style>
    .generate-title {
        color: #343a40 !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif !important;
        font-size: 2.5rem !important;
        font-weight: 900 !important;
        letter-spacing: -0.02em !important;
        margin-bottom: 1.5rem;
    }
    .autograph-code {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        word-wrap: break-word;
    }
</style>
<div class="generate-container">
    <h1 class="generate-title">Generate Autograph</h1>
    <form id="autographForm" action="{{ url_for('generate_autograph') }}" method="POST">
        <div class="form-group">
            <label for="instagram_url">Paste Instagram URL:</label>
            <input type="text" class="form-control" id="instagramUrl" name="instagram_url" required 
                   placeholder="https://www.instagram.com/p/... or https://www.instagram.com/reel/...">
            <small class="form-text text-muted">Supports both Instagram posts and reels. Make sure the content is public.</small>
        </div>
        <button type="submit" class="btn btn-primary">Generate Autographed Caption</button>
    </form>
    <div class="info-box">
        <p>The "Autographed" caption contains a secret invisible code at the end of the caption, which is used as an authentication identifier.</p>
    </div>
    <div class="result-box" style="display: none;">
        <h3>Generated Autograph</h3>
        <div class="autograph-code">
            <p id="autographed-caption"></p>
        </div>
        <div class="caption-info">
            <p>Copy the "Autographed" caption and paste it into your Instagram post or reel.</p>
        </div>
        <button class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
        <div class="alert alert-success mt-3" style="display: none;" id="copySuccess">
            Autograph code copied to clipboard!
        </div>
    </div>
</div>

<script>
document.getElementById('autographForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const instagramUrl = document.getElementById('instagramUrl').value;
    
    fetch('/api/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            instagram_url: instagramUrl
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'An error occurred');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.querySelector('.result-box').style.display = 'block';
            // Store the combined text in a data attribute
            const captionElement = document.getElementById('autographed-caption');
            captionElement.textContent = data.combined_text || '';
            captionElement.dataset.fullText = data.combined_text || '';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'An error occurred while generating the autograph.');
    });
});

async function copyToClipboard() {
    const codeElement = document.getElementById('autographed-caption');
    const textToCopy = codeElement.dataset.fullText || codeElement.textContent;
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        const successAlert = document.getElementById('copySuccess');
        successAlert.style.display = 'block';
        setTimeout(() => {
            successAlert.style.display = 'none';
        }, 3000);
    } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            const successAlert = document.getElementById('copySuccess');
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        } catch (err) {
            console.error('Failed to copy text:', err);
            alert('Failed to copy to clipboard');
        }
        document.body.removeChild(textArea);
    }
}
</script>
{% endblock %}
